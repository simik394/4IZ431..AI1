{
  "hash": "3e30a4380598aebc4552f63ef3d6a529",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: ''\naliases: []\nid: alphabeta-sim-tros01\ntags: []\nexecute:\n  echo: false\n  warning: false\n---\n\n{{<pagebreak>}}\n\n# Manuální dohrání a Analýza koncovky\n\nTato kapitola dokumentuje vývoj a ladění heuristické funkce pro koncovku **2 králové proti 1 králi**. Cílem bylo vytvořit agenta, který dokáže spolehlivě a efektivně (v minimálním počtu tahů) zvítězit proti optimálně hrajícímu soupeři.\n\n**Vizualizace herního stromu (Obrázek `\\ref{fig-assignment}`{=latex} na titulní straně)**\n\nObrázek na úvodní stránce ilustruje princip prohledávání herního prostoru pomocí algoritmu Minimax s Alpha-Beta ořezáváním:\n- **MAX uzly (Zelené/Fialové)**: Stavy, kde maximalizujeme naše skóre.\n- **MIN uzly (Červené/Azurové)**: Stavy, kde soupeř minimalizuje naše skóre.\n- **Ořezávání (Pruning)**: Šedé větve nebyly prozkoumány, protože algoritmus matematicky dokázal, že nemohou vylepšit výsledek.\n\n## Klíčové momenty a Strategie\n\nV této sekci konsolidujeme uživatelské požadavky a pozorování z průběhu vývoje. Pro úspěšné dohrání partie je nutné pochopit dynamiku koncovky.\n\n### Strategické imperativy\n\n1.  **Zachování přesily (2:1)**: Absolutní prioritou je nedostat se do situace 1:1. Výměna krále za krále vede okamžitě k remíze.\n2.  **Vytlačení z centra**: Soupeřův král se snaží držet v centru (nejsilnější pozice). Naším cílem je vytlačit ho na okraj.\n3.  **Past (The Net)**: Samotné zatlačení nestačí. Je nutné vytvořit kooperativní formaci (\"síť\"), která soupeři postupně odebere všechny bezpečné tahy.\n\n### Role králů: Kotva a Operátor\n\nBěhem analýzy jsme identifikovali dělbu rolí mezi našimi králi, kterou heuristika musí podporovat:\n-   **Kotva (Anchor)**: Drží klíčovou pozici (obvykle u rohu) a omezuje únikové cesty soupeře. Je statický.\n-   **Operátor (Operator)**: Aktivně manévruje, zmenšuje prostor a připravuje finální útok.\n\n***\n\n## Detailní rozbor heuristiky (Periodic Blocks)\n\nV této části rozebíráme jednotlivé komponenty hodnotící funkce. Každá komponenta je prezentována ve struktuře: **Požadavek $\\to$ Diskuze $\\to$ Matematika $\\to$ Implementace**.\n\n### 1. Materiál a Bezpečnost (1v1 Protection)\n\n#### Požadavek\nZabránit za každou cenu výměně, která by vedla k remíze (1 vs 1).\n\n#### Diskuze\nV běžné střední hře je výměna 1:1 přijatelná. V koncovce 2:1 je to fatální chyba. Heuristika musí vnímat stav 1:1 jako \"zakázaný\" (loss condition).\n\n#### Matematika\n$$\nh_{material} = \\begin{cases} \n-\\infty & \\text{pokud } N_{my}=1 \\land N_{opp}=1 \\\\\nw_{mat} \\cdot (N_{my} - N_{opp}) & \\text{jinak}\n\\end{cases}\n$$\n\n#### Implementace\n```{.julia include=\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\" region=\"perfect_1v1\" dedent=\"true\"}\n```\n\n### 2. Pozice a Kontrola (Red Position)\n\n#### Požadavek\nDonutit soupeře opustit bezpečné \"dvojité rohy\" (pole 1, 5, 28, 32).\n\n#### Diskuze\nČervený král v rohu je v bezpečí. Nemůžeme ho vyhodit, pokud neudělá chybu. Musíme ho aktivně \"vytlačit\" nebo \"vykouřit\" tím, že mu obsadíme sousední pole a donutíme ho k tahu (tzv. *zugzwang*).\n\n#### Implementace\n```{.julia include=\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\" region=\"perfect_red_pos\" dedent=\"true\"}\n```\n\n### 3. Koordinace (Coordination & Squeeze)\n\n#### Požadavek\nKrálové musí spolupracovat. Jeden sám nic nezmůže.\n\n#### Diskuze\nZavedli jsme koncept \"optimální vzdálenosti\". Pokud jsou naši králové příliš daleko od sebe (>6 polí), nemohou si krýt záda. Pokud jsou příliš blízko (1 pole), překážejí si. Ideální vzdálenost je 2-4 pole.\n\n#### Matematika\nHeuristika uděluje bonus $w_{coord}$, pokud:\n$$ 2 \\le dist(K_1, K_2) \\le 4 $$\n\n#### Implementace\n```{.julia include=\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\" region=\"perfect_coordination\" dedent=\"true\"}\n```\n\n### 4. Past a Síť (Net Formation)\n\n#### Požadavek\nVytvořit formaci, ze které není úniku.\n\n#### Diskuze\nToto je nejpokročilejší část heuristiky. Detekujeme, který král je blíže k rohu (\"Kotva\") a od druhého (\"Operátor\") vyžadujeme, aby se pohyboval po diagonále **směrem od rohu**, čímž uzavírá síť. Bez této složky by agent soupeře jen \"honil\" kolem dokola.\n\n#### Implementace\n```{.julia include=\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\" region=\"perfect_net\" dedent=\"true\"}\n```\n\n### 5. Prevence patu a ústupu (Retreat Penalty)\n\n#### Požadavek\nHra musí konvergovat k cíli. Nesmíme dovolit nekonečné manévrování.\n\n#### Diskuze\nObčas se stane, že AI \"nevidí\" cestu k výhře v rámci horizontu (depth limit) a rozhodne se \"čekat\" (ustoupit). Abychom tomu předešli, penalizujeme stavy, kde se průměrná vzdálenost k soupeři zvyšuje.\n\n#### Implementace\n```{.julia include=\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\" region=\"perfect_retreat\" dedent=\"true\"}\n```\n\n***\n\n## Analýza Výsledků a Parametry\n\nNásledující tabulka shrnuje váhy použité ve finální verzi heuristiky (`perfect_endgame_heuristic`). Tyto hodnoty byly laděny pomocí ablačních studií.\n\n```julia\n#| label: tbl-params\n#| tbl-cap: \"Parametry heuristické funkce (načteno z kódu)\"\n#| output: asis\n\ninclude(\"/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl\")\nusing Markdown\n\n# Vytvoření tabulky z konstanty PERFECT_WEIGHTS\nkey_map = Dict(\n    :MATERIAL => \"Materiál (Základ)\",\n    :WIN => \"Výhra (Infinity)\",\n    :SAFETY_RED => \"Penalta: Červený v bezpečí\",\n    :ACTIVE_RED => \"Bonus: Červený aktivní\",\n    :COORD => \"Koordinace králů\",\n    :SQUEEZE => \"Sevření (Squeeze)\",\n    :RETREAT_MAX => \"Penalta: Ústup (Max)\",\n    :NET => \"Past (Net Formation)\",\n    :CROWDING => \"Přeplnění (Crowding)\",\n    :MOBILITY => \"Mobilita soupeře\"\n)\n\nprintln(\"| Komponenta | Váha | Význam |\")\nprintln(\"|---|---|---|\")\nfor (k, desc) in sort(collect(key_map), by=x->string(x[1]))\n    val = PERFECT_WEIGHTS[k]\n    println(\"| **$desc** | `$val` | Koeficient v lineární kombinaci |\")\nend\n```\n\n### Pozorování: Horizont Efekt\n\nPři hloubce prohledávání 6 (3 tahy každého) se stále setkáváme s \"Horizont efektem\". Agent může odsunout nevyhnutelnou prohru o tah dál, i když to z dlouhodobého hlediska nic neřeší. \n\n> **Řešení**: Zavedení \"pseudo-terminálních\" stavů (např. penalizace za ústup), které heuristicky simulují \"blížící se konec\", i když není přímo vidět ve stromu.\n\n***\n\n## Průběh hry (Manuální analýza)\n\nNásledující sekvence snímků (z Excalidraw) vizuálně demonstruje úspěšné uplatnění výše popsaných principů v praxi.\n\n<!--\n::: {#fig-game-phases layout-ncol=2}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=6plydeepbutstillstarting|Fáze 1 - Horizont efekt - AI vidí hrozbu, ale je těsně za horizontem.]]{#fig-phase1}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=safecornerblock|Fáze 2a - Safe Corner Block - Úspěšné zablokování úniku.]]{#fig-phase2a}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=doublecornerblunder|Fáze 2b - Ukázka chyby (Blunder) - Červený uniká.]]{#fig-phase2b}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=decisivemoment1|Fáze 3 - Vytlačení z rohu (Pushing).]]{#fig-phase3}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=expected-optimal-ply1|Fáze 4 - Formování pasti (Net building) - Kotva a Operátor.]]{#fig-phase4}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=needlesstodivedeeper|Fáze 5 - Vynucené tahy (Forced Moves).]]{#fig-phase5}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=insta-lost|Fáze 6 - Finální past (Impossible to escape).]]{#fig-phase6}\n\n![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=forcedending|Fáze 7 - Vynucený konec (Forced Ending).]]{#fig-phase7}\n\nManuální analýza klíčových fází hry\n:::\n-->\n\n> **Poznámka:** Vizuální analýza fází hry (exporty z Excalidraw) není v této verzi dokumentu k dispozici. Odkazujeme na zdrojové soubory v repozitáři.\n\n***\n\n\n***\n\n## Případová studie: Rozhodování v Hloubce 6\n\nBěhem ladění heuristiky jsme narazili na kritickou situaci, kde AI v hloubce 6 (3 tahy každého) váhala mezi dvěma tahy. Tato situace krásně ilustruje, jak jemné změny v definici metriky ovlivňují chování agenta.\n\n**Konflikt:**\n- **Optimální tah (14-9)**: Vede přímo k obsazení klíčového bodu pro sestrojení pasti.\n- **Suboptimální tah (10-7)**: Vypadá bezpečně a udržuje vzdálenost, ale v reálu ztrácí tempo a dává soupeři šanci uniknout.\n\nPůvodní heuristika ohodnotila oba tahy téměř stejně. Důvodem byla **Manhattanská vzdálenost**, která v dámě (kde se chodí po diagonálách) měřila vzdálenost $\\Delta x + \\Delta y$ nepřesně. Pro krále jsou pole 9 a 2 topologicky stejně vzdálená (Vzdálenost 2), i když pole 9 je strategicky mnohem cennější.\n\n**Řešení:**\nPřechod na **Čebyševovu vzdálenost** ($\\max(|\\Delta x|, |\\Delta y|)$). Tato metrika správně identifikovala, že pole 5 (cíl) je z pole 9 dosažitelné za 1 krok (Vzdálenost 1), zatímco z pole 2 je to stále daleko.\n\n**Výsledek po úpravě:**\n- **Optimální tah (14-9)**: Skóre **4160.0** (Aktivní bonus za přiblížení).\n- **Suboptimální tah (10-7)**: Skóre **3670.0** (Bez bonusu).\n- **Rozdíl**: **+490.0** bodů jasně preferuje vítěznou variantu.\n\nTato změna umožnila agentovi najít vítěznou sekvenci: `14-9` $\\to$ `1-5` $\\to$ `10-14` $\\to$ `5-1` $\\to$ `9-5` $\\to$ `1-6` $\\to$ `5-1` $\\to$ `6-2` $\\to$ `14-18`.\n\n***\n\n### Závěr k analýze\nJakmile se podaří sestavit \"síť\" (princip #4), hra přechází do deterministické fáze. Heuristika v této chvíli dává tak vysoké skóre, že Alpha-Beta ořezávání eliminuje téměř všechny ostatní větve a agent hraje prakticky okamžitě.\n\n",
    "supporting": [
      "alphabeta-sim-tros01_files/figure-pdf"
    ],
    "filters": []
  }
}